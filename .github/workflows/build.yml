name: 最终重构版-生成EXE
on: workflow_dispatch

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: 1. 准备环境 (vcpkg)
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat

    - name: 2. 安装依赖 (ImGui, GLFW, Boost)
      run: .\vcpkg\vcpkg install glfw3:x64-windows imgui[core,glfw-binding,opengl3-binding]:x64-windows boost-asio boost-system boost-thread boost-date-time boost-regex:x64-windows

    - name: 3. 现场手搓 Nanoid
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "nanoid_root\nanoid"
        $code = @"
        #pragma once
        #include <string>
        #include <random>
        namespace nanoid {
            static const std::string _default_dict = "_-0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
            inline std::string generate(int size = 21) {
                if (size <= 0) return "";
                std::random_device rd;
                std::mt19937 gen(rd());
                std::uniform_int_distribution<> dis(0, 63);
                std::string res;
                res.reserve(size);
                for (int i = 0; i < size; ++i) { res += _default_dict[dis(gen)]; }
                return res;
            }
        }
        "@
        Set-Content -Path "nanoid_root\nanoid\nanoid.h" -Value $code

    - name: 4. 部署 Steam SDK
      shell: powershell
      run: |
        $url = "https://github.com/bwwq/test/raw/main/steamworks_sdk_163.zip"
        Invoke-WebRequest -Uri $url -OutFile "sdk.zip" -ErrorAction Stop
        if ((Get-Item "sdk.zip").Length -lt 1000) { throw "SDK file invalid" }
        
        Expand-Archive -Path "sdk.zip" -DestinationPath "steam_sdk_raw" -Force
        
        # 整理出一个干净的 steam_sdk 目录
        New-Item -ItemType Directory -Force -Path "steam_sdk\public\steam" 

[Image of Directory Structure]

        New-Item -ItemType Directory -Force -Path "steam_sdk\lib"
        
        # 复制头文件
        $headerRoot = Get-ChildItem -Path "steam_sdk_raw" -Recurse -Filter "steam_api.h" | Select-Object -First 1
        Copy-Item -Path "$($headerRoot.DirectoryName)\*.h" -Destination "steam_sdk\public\steam" -Force
        
        # 复制 Lib
        $libFile = Get-ChildItem -Path "steam_sdk_raw" -Recurse -Filter "steam_api64.lib" | Select-Object -First 1
        Copy-Item -Path $libFile.FullName -Destination "steam_sdk\lib\steam_api64.lib" -Force
        
        # 复制 DLL 到构建目录 (运行必需)
        New-Item -ItemType Directory -Force -Path "build\Release"
        $dllFile = Get-ChildItem -Path "steam_sdk_raw" -Recurse -Filter "steam_api64.dll" | Select-Object -First 1
        Copy-Item -Path $dllFile.FullName -Destination "build\Release\steam_api64.dll" -Force

    - name: 5. 【核弹】重写 CMakeLists.txt
      shell: powershell
      run: |
        # 我们不再修补原来的烂代码，直接覆盖写入一个新的，逻辑清晰的构建文件
        $cmakeContent = @"
        cmake_minimum_required(VERSION 3.15)
        project(ConnectTool)
        set(CMAKE_CXX_STANDARD 17)

        # 1. 查找依赖
        find_package(glfw3 CONFIG REQUIRED)
        find_package(imgui CONFIG REQUIRED)
        find_package(Boost REQUIRED COMPONENTS system thread date_time regex asio)

        # 2. 收集源文件
        file(GLOB_RECURSE SOURCES "net/*.cpp" "steam/*.cpp" "online_game_tool.cpp")

        add_executable(ConnectTool `$`{SOURCES})

        # 3. 设置头文件包含路径
        target_include_directories(ConnectTool PRIVATE
            `$`{CMAKE_CURRENT_SOURCE_DIR}/nanoid_root           # Nanoid
            `$`{CMAKE_CURRENT_SOURCE_DIR}/steam_sdk/public      # Steam SDK
        )

        # 4. 链接库文件 (这是解决 LNK2019 的关键)
        target_link_libraries(ConnectTool PRIVATE
            imgui::imgui
            glfw
            Boost::system Boost::thread Boost::date_time Boost::regex
            # 强制链接 Steam Lib
            `$`{CMAKE_CURRENT_SOURCE_DIR}/steam_sdk/lib/steam_api64.lib
            ws2_32 # Windows Socket 库
        )
        
        # 5. 复制 DLL 到输出目录 (方便调试)
        file(COPY `$`{CMAKE_CURRENT_SOURCE_DIR}/steam_sdk/lib/steam_api64.lib DESTINATION `$`{CMAKE_BINARY_DIR}/Release)
        "@
        
        Set-Content -Path "CMakeLists.txt" -Value $cmakeContent
        Write-Output "CMakeLists.txt has been rewritten from scratch!"

    - name: 6. 编译项目
      run: |
        New-Item -ItemType Directory -Force -Path "build"
        cd build
        # 此时我们的 CMakeLists 已经是完美的了，不需要额外的怪异参数
        cmd /c "cmake .. -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows"
        cmd /c "cmake --build . --config Release"

    - name: 7. 上传成品
      uses: actions/upload-artifact@v4
      with:
        name: ConnectTool-Windows
        path: build/Release/*
