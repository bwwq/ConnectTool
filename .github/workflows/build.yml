name: 最终决战版-生成EXE
on: workflow_dispatch

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    # 1. 准备 vcpkg
    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat

    # 2. 安装 Boost (这步最慢，耐心等待)
    - name: Install Boost Dependencies
      run: .\vcpkg\vcpkg install boost-asio boost-system boost-thread boost-date-time boost-regex:x64-windows

    # 3. 下载 SDK (使用精简的单行逻辑，防止语法错误)
    - name: Clone Steamworks SDK
      shell: powershell
      run: |
        # 尝试下载，如果失败则尝试备用源，所有逻辑写在一行
        git clone --depth 1 https://github.com/Dummiesman/Steamworks-SDK.git temp_sdk; if (-not (Test-Path "temp_sdk")) { git clone --depth 1 https://github.com/Metapyziks/Steamworks-SDK.git temp_sdk }
        
        # 检查是否成功
        if (-not (Test-Path "temp_sdk")) { Write-Error "SDK下载失败"; exit 1 }

        # 建立目录
        New-Item -ItemType Directory -Force -Path ".\steam"
        New-Item -ItemType Directory -Force -Path ".\lib"
        New-Item -ItemType Directory -Force -Path ".\build\Release"

        # 暴力复制所有可能的头文件到 steam 目录
        Get-ChildItem -Path ".\temp_sdk" -Recurse -Filter "*.h" | Copy-Item -Destination ".\steam\" -Force

        # 暴力搜索并复制 lib 文件
        Get-ChildItem -Path ".\temp_sdk" -Recurse -Filter "steam_api64.lib" | Select-Object -First 1 | Copy-Item -Destination ".\lib\" -Force
        Get-ChildItem -Path ".\temp_sdk" -Recurse -Filter "steam_api64.lib" | Select-Object -First 1 | Copy-Item -Destination ".\steam\" -Force

        # 暴力搜索并复制 dll 文件
        Get-ChildItem -Path ".\temp_sdk" -Recurse -Filter "steam_api64.dll" | Select-Object -First 1 | Copy-Item -Destination ".\build\Release\" -Force

    # 4. 编译
    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows -DCMAKE_CXX_FLAGS="-I../vcpkg/installed/x64-windows/include"
        cmake --build . --config Release

    # 5. 上传
    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: ConnectTool-Final
        path: build/Release/*
